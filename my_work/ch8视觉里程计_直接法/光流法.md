# 光流法

### 光流法的基本原理与数学推导
**亮度恒定假设**: 在短时间内，一个像素点的亮度（或者说灰度值）在连续两帧图像中是保持不变的。

假设在时间 $t$ 时刻，图像上坐标为 $(x, y)$ 的像素点，其亮度值为 $I(x, y, t)$。当相机或物体移动，经过一个极短的时间 $\Delta t$ 后，这个像素点移动到了新的位置 $(x+\Delta x, y+\Delta y)$，其亮度值变为 $I(x+\Delta x, y+\Delta y, t+\Delta t)$。根据亮度恒定假设，我们有：

$$I(x, y, t) = I(x+\Delta x, y+\Delta y, t+\Delta t)$$

现在，我们对等式右边的 $I(x+\Delta x, y+\Delta y, t+\Delta t)$ 进行**泰勒展开**：

$$I(x+\Delta x, y+\Delta y, t+\Delta t) \approx I(x, y, t) + \frac{\partial I}{\partial x}\Delta x + \frac{\partial I}{\partial y}\Delta y + \frac{\partial I}{\partial t}\Delta t$$

---
将泰勒展开后的式子代入亮度恒定等式，并约去 $I(x, y, t)$，得到：

$$\frac{\partial I}{\partial x}\Delta x + \frac{\partial I}{\partial y}\Delta y + \frac{\partial I}{\partial t}\Delta t = 0$$

为了方便，我们用 $I_x, I_y, I_t$ 分别表示图像在 $x, y, t$ 方向上的偏导数：

$$I_x \Delta x + I_y \Delta y + I_t \Delta t = 0$$

然后我们用时间 $\Delta t$ 去除整个等式：

$$I_x \frac{\Delta x}{\Delta t} + I_y \frac{\Delta y}{\Delta t} + I_t = 0$$

---
定义光流向量为 $\mathbf{v} = (u, v)$，其中 $u = \frac{\Delta x}{\Delta t}$ 和 $v = \frac{\Delta y}{\Delta t}$ 分别表示像素点在 $x$ 和 $y$ 方向上的速度。这个等式就是著名的**光流约束方程（Optical Flow Constraint Equation）**：

$$I_x u + I_y v + I_t = 0$$

这个方程是一个关于两个未知数 $(u, v)$ 的方程，对于一个像素点来说，我们只有一个方程，无法求解出唯一的光流向量。这就引出了**孔径问题（Aperture Problem）**：我们无法仅仅通过观察一个像素点来确定它的运动方向，因为在局部区域内，一个边缘的运动可能在多个方向上都产生相同的亮度变化。


为了解决这个问题，需要引入**额外的约束条件**，于是发展出了不同的光流算法。其中最经典的两种是Lucas-Kanade光流和Horn-Schunck光流。
------------------------------

#### 1. Lucas-Kanade（L-K）光流法

L-K光流法属于**稀疏光流**，它只计算图像中一些特定的、易于追踪的**特征点**的光流。它引入了第二个假设：**空间一致性假设**，即一个像素点周围邻域内的所有像素都具有相同的光流向量。

根据这个假设，L-K光流法在一个以待追踪点为中心的窗口（例如一个 $3 \times 3$ 或 $5 \times 5$ 的窗口）内，对所有像素都应用光流约束方程。如果窗口大小为 $w \times w$，那么我们就会得到 $w^2$ 个方程。这些方程可以写成一个线性方程组：

$$
\begin{bmatrix}
I_{x1} & I_{y1} \\
I_{x2} & I_{y2} \\
\vdots & \vdots \\
I_{xn} & I_{yn}
\end{bmatrix}
\begin{bmatrix}
u \\
v
\end{bmatrix}
=
-
\begin{bmatrix}
I_{t1} \\
I_{t2} \\
\vdots \\
I_{tn}
\end{bmatrix}
$$

用矩阵形式表示为 $\mathbf{A} \mathbf{v} = \mathbf{b}$。这是一个超定方程组（方程数多于未知数），可以使用最小二乘法来求解最优的 $(u, v)$。最小化误差函数：

$$E(u, v) = \sum_{i=1}^{n} (I_{xi} u + I_{yi} v + I_{ti})^2$$

为了找到 $u, v$ 的最优解，我们对 $E(u, v)$ 求偏导并令其为0：

$$
\frac{\partial E}{\partial u} = 2 \sum_{i=1}^{n} (I_{xi} u + I_{yi} v + I_{ti}) I_{xi} = 0 \\
\frac{\partial E}{\partial v} = 2 \sum_{i=1}^{n} (I_{xi} u + I_{yi} v + I_{ti}) I_{yi} = 0
$$

整理得到：

$$
\begin{bmatrix}
\sum I_{xi}^2 & \sum I_{xi} I_{yi} \\
\sum I_{xi} I_{yi} & \sum I_{yi}^2
\end{bmatrix}
\begin{bmatrix}
u \\
v
\end{bmatrix}
=
-
\begin{bmatrix}
\sum I_{xi} I_{ti} \\
\sum I_{yi} I_{ti}
\end{bmatrix}
$$

这可以写成 $\mathbf{A}^T \mathbf{A} \mathbf{v} = \mathbf{A}^T \mathbf{b}$，其中 $\mathbf{A}^T \mathbf{A}$ 是一个 $2 \times 2$ 的矩阵。求解这个线性方程组，就可以得到光流向量 $\mathbf{v} = (u, v)$。

---
### 光流法在SLAM中的应用

光流法在SLAM中的主要作用是提供**视觉里程计（Visual Odometry, VO）**部分的数据关联。它通过追踪图像中的特征点，来估计相机在两帧之间的运动。相比于传统的基于特征匹配（Feature Matching）的VO，光流法有其独特的优势和劣势。

#### 具体实现

在SLAM中，光流法通常以以下方式实现：

1.  **特征点选择**：首先，在当前帧图像中选择一些易于追踪的特征点。这些特征点通常是图像中纹理丰富、梯度变化大的区域，比如角点。例如，可以使用 Shi-Tomasi 算法来检测适合追踪的角点。

2.  **光流追踪**：对于第一步选出的特征点，使用Lucas-Kanade光流法在下一帧图像中找到它们新的位置。这个过程非常高效，因为L-K光流法是稀疏的，只计算少量特征点的运动。

3.  **剔除异常点**：在追踪过程中，由于遮挡、光照变化等原因，有些特征点可能会追踪失败。需要通过一些方法（如RANSAC、对极几何约束等）来剔除这些不准确的匹配点。

4.  **运动估计**：利用追踪成功的特征点在两帧中的位置，以及相机的内参，可以通过**对极几何**或**PnP（Perspective-n-Point）**等方法来求解相机的运动（旋转和平移）。

5.  **更新地图**：将估计出的相机位姿和新的特征点加入到地图中，并为后续的后端优化、回环检测等模块提供数据。

#### 优点与缺点

---
**优点：**

* **计算效率高**：L-K光流法只追踪稀疏的特征点，计算量远小于密集光流法，因此可以满足SLAM对实时性的要求。
* **鲁棒性好**：在弱纹理场景下，传统特征点法可能无法提取足够多的匹配点，而光流法由于其基于局部邻域的假设，对弱纹理场景有更好的鲁棒性。
* **帧间关联简单**：光流法直接在帧间进行追踪，避免了复杂的描述子计算和匹配过程，使得数据关联更为简单。

**缺点：**

* **只适用于小运动**：光流法基于泰勒展开，要求相机在两帧之间的运动非常小。如果运动过快，光流约束方程就不再成立，追踪就会失败。
* **不处理大场景变化**：光流法无法处理大的视角变化，因为这会使得亮度恒定假设失效。
* **累积误差**：作为视觉里程计的一部分，光流法本身也会产生漂移，需要后端优化和回环检测来修正。

在现代的SLAM系统中，尤其是单目或视觉-惯性（VIO）系统中，光流法常被用于提供高频、实时的帧间运动估计，而特征点法则用于关键帧之间的运动估计和回环检测，两者结合可以互补，从而实现更鲁棒和精确的定位。