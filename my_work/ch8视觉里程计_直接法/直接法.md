#### 核心理念
**光度一致性**（Photometric Consistency）: 即假设在理想情况下，三维空间中的同一个物理点，在不同相机视角下的图像投影，其像素亮度值应该保持相同。

基于这一核心假设，直接法将相机运动估计问题转化为一个优化问题，其目标是**最小化图像之间的光度误差**（Photometric Error）   

然而，这种方法也引入了新的敏感性，例如对光照变化、相机自动曝光调整或物体表面反射特性的敏感性。这是决定直接法优缺点的一个基础性假设。

## 直接法流程概述

### 像素灰度与相机运动的几何关系
直接法通过假设一个三维点的强度与其在不同图像帧上的二维投影之间存在直接且恒定的关系  

### 光度误差的定义与构建
光度误差$e = I_2(p_2) - I_1(p_1)$  
其中，$I1$​ 和 I2​ 分别代表第一帧（参考帧）和第二帧（当前帧）图像的像素亮度值。p1​ 是参考帧中的像素坐标，而 p2​ 则是 p1​ 对应的三维空间点经过相机运动变换（旋转 R 和平移 t）和深度信息 d 投影到第二帧后的像素坐标。    
直接法将位姿估计问题表述为对像素强度进行连续优化。这种方法允许实现亚像素级别的精度，并能够潜在地利用图像中更密集的像素信息。  

### 优化目标：最小化光度误差  
$ T_{mini} \in \text{pixels} \sum \left| I_2(p_2(p_1, T, d)) - I_1(p_1) \right|^2 $  
具体来说，p2​ 是 p1​ 及其深度 d 经过相机位姿 T（由 R 和 t 构成）变换后的投影结果，即 p2​(p1​,T,d)。   

最小化光度误差通常是一个非线性、非凸的优化问题。迭代优化算法可能会陷入局部最小值。  
这种固有的挑战要求在实际应用中采取一系列策略，例如提供良好的相机位姿初始猜测、使用鲁棒的损失函数（如Huber核函数 7）来抑制离群点的影响，以及可能采用多尺度方法（如图像金字塔 12）来改善收敛性并避免不良解决方案。  

### 深度信息的利用：单目、双目与RGB-D相机
**单目相机**：  
--------------
深度估计： 单目相机通过自身的移动来估计深度，这种深度估计是动态的，即需要相机在不同位置拍摄多张图像才能推断出深度信息。  

尺度不确定性： 单目相机作为唯一的传感器时，无法确定场景的绝对尺度信息。这意味着通过单目视觉估计出的轨迹和地图，其大小是相对于真实世界有一个未知的尺度因子。因此，估计结果只能在未知尺度因子下恢复。如果尺度仅在初始化过程中确定，那么在后续的连续测量中，很可能会发生尺度漂移，导致轨迹的累积误差不断放大。  

初始化：单目视觉里程计在进行PnP（Perspective-n-Point）位姿估计前，通常必须进行初始化。**初始化过程通常需要相机有足够的平移运动（而非纯旋转）**，以便通过三角测量等方法来三角化出初始的三维点，从而解决尺度不确定性问题  

双目/RGB-D相机：  
-------------
直接深度获取： RGB-D相机能够直接测量图像中每个像素到相机的距离，从而提供丰富的深度信息。双目相机则通过左右两幅图像的视差来计算深度信息，且可以在静止状态下完成深度获取。  

PnP应用：由于双目或RGB-D相机能够直接获取特征点的三维位置，因此在基于这些相机的视觉里程计中，可以直接使用PnP算法来估计相机运动，而无需依赖对极约束来求解位姿。PnP方法是姿态估计中非常重要的一种，它在仅有少量匹配点的情况下也能获得较好的运动估计  

三角测量（Triangulation）：  
-----------------
三维点恢复：在单目视觉里程计中，当相机在不同位置拍摄图像后，可以通过三角测量来获得图像点对应的三维位置。  
步骤：三角测量的基本步骤通常包括：首先进行像素点的匹配，然后（对于单目情况）确定极线，最后根据对极约束和几何关系计算出匹配像素点的深度值 。

------------------------

尽管直接法主要操作于像素强度信息，但它们在地图构建时，以及有时在初始化或使用PnP算法时，仍然需要三维点信息。  
这意味着，虽然直接法避免了显式的特征匹配来估计位姿，但它们通常仍然依赖几何原理进行地图构建或初始深度估计。**三角测量的准确性直接影响着最终三维地图的质量和位姿估计的精度**.


## 直接法的数学推导与求解
方法：光束法平差（Bundle Adjustment, BA），通过同时调整相机位姿和三维点坐标来最小化重投影误差。  

在直接法中，光度误差 $e = I_2(\mathbf{p}_2(\mathbf{T})) - I_1(\mathbf{p}_1)$ 对相机位姿 $\mathbf{T} $的导数需要通过链式法则进行计算。具体来说，其导数可以表示为：  
$
\frac{\partial e}{\partial \mathbf{T}} = \frac{\partial I_2}{\partial \mathbf{p}_2} \frac{\partial \mathbf{p}_2}{\partial \mathbf{T}}$

- $\frac{\partial I_2}{\partial \mathbf{p}_2}$：这一项表示图像 I_2 在像素点 \mathbf{p}_2 处的梯度。它量化了像素亮度值随像素坐标变化的速率。图像梯度是直接法能够工作的关键，因为它指明了在图像平面上哪个方向的亮度变化最剧烈。
- $\frac{\partial \mathbf{p}_2}{\partial \mathbf{T}}$：这一项表示像素坐标 $\mathbf{p}_2$ 随相机位姿 $\mathbf{T}$ 变化的速率。它的计算涉及到相机的内参、外参以及三维点的深度信息。通过这个导数，我们可以知道相机位姿的微小变化如何影响三维点在图像上的投影位置。  

迭代求解方法：高斯-牛顿法与列文伯格-马夸尔特法   
列文伯格-马夸尔特法（Levenberg-Marquardt, LM）： LM法是高斯-牛顿法的一种改进，它巧妙地结合了高斯-牛顿法和梯度下降法的优点。当初始值距离最优解较远时，LM法表现得更像梯度下降法，具有更好的全局收敛性，能够更稳定地找到解；而当迭代过程接近最优解时，它又表现得更像高斯-牛顿法，收敛速度更快 。  

**鲁棒性处理：离群点剔除与Huber核函数**  
在实际的视觉里程计系统中，图像数据往往受到多种因素的影响，如光照变化、视角变化、运动模糊、相机噪声等，导致相邻图像帧之间可能存在较大差异 。  
**离群点剔除方法：**

1. RANSAC (Random Sample Consensus)： 随机采样一致性算法是一种迭代方法，通过随机选择最小样本集来估计模型参数，并从中识别出符合模型的内点（inliers）和不符合模型的离群点。   
2. LMedS (Least Median of Squares)： 最小中值平方是一种比RANSAC更具鲁棒性的估计方法。其目标是最小化残差的中值，而不是残差的平方和，因此对离群点不那么敏感。  
3. MSAC (M-estimator SAmple Consensus)： M估计器采样一致性是RANSAC的一种变体，它通过设置一个距离阈值来确定内点，通常比标准RANSAC算法收敛更快 。    

**Huber核函数：**  
除了上述离群点剔除算法，在非线性优化中，还可以引入**鲁棒核函数（Robust Kernel Function）**来减小离群点对优化过程的影响。  
Huber核函数：在误差较小时（即内点），采用平方误差（L2范数）进行惩罚，保持优化效率；而在误差较大时（即离群点），则采用线性误差（L1范数）进行惩罚。   
这种设计有效地抑制了大的误差（离群点）对总损失函数的贡献，使得优化过程更加稳定，避免了少数离群点主导整个优化结果的情况 。   


## 直接法的分类与典型算法解析
### A. 稀疏直接法
稀疏直接法的核心思想是仅利用图像中**具有大梯度的稀疏像素点进行优化**。这些点通常位于图像中**亮度变化最剧烈的区域**，因此包含了最丰富的信息，在某种程度上类似于特征点。  
DSO (Direct Sparse Odometry) 

### B. 半稠密直接法 
半稠密直接法的核心思想是利用图像中所有具有**明显梯度的像素点（如边缘）进行优化**，而**忽略那些亮度变化平缓的区域**。它介于稀疏和稠密之间，只处理那些提供足够信息（即有足够梯度）的像素  
LSD-SLAM (Large-Scale Direct SLAM)

### C. 稠密直接法
稠密直接法的核心思想是**利用图像中的所有像素点进行优化**，旨在构建一个完整的、高密度的三维地图。  
DTAM (Dense Tracking and Mapping)   



