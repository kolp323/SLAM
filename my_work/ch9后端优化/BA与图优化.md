# Bundle Adjustment（光束法平差，简称BA）
### 目标：联合优化相机位姿和三维点坐标   

### 重投影误差：BA代价函数的核心构建块  
这些误差项的计算方式是：首先，将三维空间中的特征点（路标点）根据当前估计的相机姿态和内参，投影到相机图像平面上，得到一个预测的二维图像坐标。然后，将这个预测坐标与该特征点在实际图像中观测到的二维坐标进行比较。这两者之间的差异，即为重投影误差 。  

重投影误差的几何意义在于，它直接量化了三维重建模型（由相机姿态和三维点位置定义）与实际二维图像观测之间的不一致性。最小化这个误差，本质上是让三维模型在所有二维图像上看起来“最合理”，从而使得模型与实际观测数据尽可能地匹配。这种误差定义使得BA问题能够被有效地转化为一个非线性最小二乘问题，从而可以使用成熟的优化算法进行求解。

### 数学形式: 最小二乘问题与误差项的构建

Bundle Adjustment 的优化问题通常被表述为一个非线性最小二乘问题。其目标是找到一组参数 x（包括所有相机位姿和所有三维点的坐标），使得一个由重投影误差构成的代价函数最小化。这个代价函数通常定义为残差向量的平方L2范数之和。

具体来说，目标函数可以定义为：

$\min_{x} \frac{1}{2} \| r(x) \|^2$

其中，r(x) 是残差向量。残差向量的每个元素 $r_{ij}$ 对应于第 i 个相机对第 j 个三维点的重投影误差，通常是一个二维向量（在图像平面上的 u, v 坐标误差）。

$r_{ij} = \mathbf{p}_{ij} - \pi(\mathbf{T}_{i}, \mathbf{X}_{j})$

这里，$\mathbf{p}_{ij}$ 是第 i 个相机观测到的第 j 个特征点的二维图像坐标，$\pi(\mathbf{T}_{i}, \mathbf{X}_{j})$ 是将第 j 个三维点 $\mathbf{X}_{j}$ 通过第 i 个相机的位姿 $\mathbf{T}_{i}$ 和内参投影到图像平面上的预测坐标。

将BA问题表述为非线性最小二乘问题，使其能够利用现有的大量成熟的优化理论和算法，例如高斯-牛顿法和列文伯格-马夸尔特算法。这种标准化是实现高效求解的基础，也是BA能够被广泛应用并取得成功的关键。  

### BA 的求解：迭代优化算法
**高斯-牛顿法：基于雅可比矩阵的迭代方向**：  
它通过在当前估计点处对非线性残差函数进行一阶泰勒展开，将其近似为线性函数，从而将非线性最小二乘问题转化为一系列线性最小二乘问题。在每一步迭代中，高斯-牛顿算法会计算残差向量 r(x) 对参数 x 的雅可比矩阵 J(x)。然后，它通过求解所谓的正规方程来确定参数的更新方向 p：

$J^T J p = -J^T r$

其中，$J^T J$构成了海森矩阵的近似（或称为高斯-牛顿近似海森矩阵）。求解这个线性方程组可以得到一个使局部线性化后的代价函数下降最快的方向 p，然后将当前参数 $x_k$ 更新为 $x_{k+1} = x_k + p$。  

高斯-牛顿法在接近最优解时收敛速度快（二次收敛），但其主要缺点是可能不收敛，特别是当初始值远离最优解或者海森矩阵近似不正定时。

**列文伯格-马夸尔特 (LM) 算法：高斯-牛顿与梯度下降的混合**  

LM算法通过引入一个阻尼因子$\lambda$（或$\mu$）来实现在这两种方法之间的自适应切换。在每次迭代中，LM算法更新状态向量$K_v$的步长$dK_v$如下：

$dK_v = (J^T J + \lambda I)^{-1} J^T c_v$

其中$J$是代价向量$c_v$对状态向量$K_v$的雅可比矩阵。

当$\lambda$值较小或趋近于零时，LM算法的行为更接近于高斯-牛顿法，收敛速度快。  
当$\lambda$值较大时，算法的步长会变小，行为更接近于梯度下降法，它总是采取能够降低代价函数的步骤，因此更稳定，但收敛速度可能较慢，尤其是在接近最小值时。  

LM算法会根据每次迭代的成功或失败（即代价函数是否减小）来调整$\lambda$的值：如果当前步成功，则减小$\lambda$以加速收敛；如果失败，则增大$\lambda$以增加稳定性。

**收敛性分析与初始值的重要性**

BA是一个非线性迭代过程，其中初始值的质量至关重要。  
非线性优化算法普遍存在容易陷入局部最小值的风险，这意味着如果初始估计值与全局最优解相距甚远，算法可能会收敛到一个次优解，而不是全局最佳解。

一个良好的初始估计**通常由视觉里程计（VO）或结构与运动（SfM）算法提供** 。VO提供了相邻帧之间的相对运动，通过串联这些相对运动可以得到一个初步的轨迹和地图。尽管这个初步结果可能存在累积误差，但它为后端优化提供了一个合理的起点。

### 稀疏性和边缘化：提升效率的关键

BA问题的稀疏结构：海森矩阵的块稀疏性。即矩阵中大部分元素为零。  

舒尔补 (Schur Complement) 技巧：利用稀疏性加速求解。海森矩阵可以被分解为与相机参数相关的块、与三维点参数相关的块，以及连接这两者的交叉块。  

边缘化 (Marginalization) 策略：将旧状态或不活跃路标点边缘化。将旧的或不活跃的变量所包含的信息（它们的约束和不确定性）编码到剩余变量的先验信息中。


###  鲁棒核函数：应对异常值
异常值可能来源于多种情况：错误的特征匹配、动态物体、传感器瞬时故障 

标准的最小二乘优化方法对这些异常值非常敏感。  

**鲁棒核函数（Robust Kernel Function** 被引入到代价函数中，其核心思想是，将传统的重投影误差平方项 $ρ(e)=e^2$
替换为一个增长较慢的非线性函数。对于较小的误差（被认为是内点），鲁棒核函数近似于平方函数，保持了最小二乘的特性；但对于较大的误差（被认为是异常值），它会限制其增长，使其对总代价的贡献不再呈平方关系，甚至在误差达到一定阈值后，其贡献几乎不再增加。  

常见鲁棒核函数介绍：Huber, Cauchy, Tukey  

